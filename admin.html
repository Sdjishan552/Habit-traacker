<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Timetable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <style>
    .admin-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, #f7f3eb, #eef6f8);
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      flex-wrap: wrap;
    }

    /* Success highlight */
    .card-success {
      background: linear-gradient(
        135deg,
        rgba(46,204,113,0.15),
        rgba(46,204,113,0.08)
      ) !important;
      border: 1px solid rgba(46,204,113,0.4);
      transition: all 0.6s ease;
    }

    /* Blue countdown button */
    .admin-bar .countdown-input button {
      background: #2563eb;
      color: white;
      font-weight: 600;
    }

    .admin-bar .countdown-input button:hover {
      background: #1e4ed8;
    }
  </style>
</head>

<body class="admin-body">

<header>
  <h1>Admin Panel</h1>
  <div>Restricted Access</div>
</header>

<div class="admin-bar" id="adminBar" style="display:none">
  <button onclick="addEvent()">âž• Add Event</button>

  <button onclick="masterReset()" 
    style="background:#e53935; color:white;">
    ðŸ—‘ Master Reset
  </button>

  <div class="countdown-input">
    <input type="date" id="adminCountdownDate">
    <button onclick="saveAdminCountdown()">Set</button>
  </div>

  <button onclick="goHome()">â¬… Home</button>
</div>

<main id="main"></main>

<script>

/* ================= PIN SYSTEM ================= */

const main = document.getElementById("main");
const adminBar = document.getElementById("adminBar");

function askForPin() {
  const savedPin = localStorage.getItem("adminPin");

  if (!savedPin) {
    main.innerHTML = `
      <div class="card admin-card">
        <h2>Set Admin PIN</h2>
        <input id="newPin" type="password" placeholder="Create PIN">
        <button onclick="setPin()">Set PIN</button>
      </div>
    `;
  } else {
    main.innerHTML = `
      <div class="card admin-card">
        <h2>Enter Admin PIN</h2>
        <input id="pinInput" type="password" placeholder="Enter PIN">
        <button onclick="verifyPin()">Unlock</button>
      </div>
    `;
  }
}

function setPin() {
  const pin = document.getElementById("newPin").value.trim();
  if (pin.length < 4) {
    alert("PIN must be at least 4 digits.");
    return;
  }
  localStorage.setItem("adminPin", pin);
  loadAdmin();
}

function verifyPin() {
  const pin = document.getElementById("pinInput").value.trim();
  if (pin === localStorage.getItem("adminPin")) {
    loadAdmin();
  } else {
    alert("Wrong PIN.");
  }
}

/* ================= TIMETABLE ================= */

let timetable = [];

function loadTimetable() {
  try {
    const raw = localStorage.getItem("timetable");
    if (!raw) return [];
    return JSON.parse(raw) || [];
  } catch {
    localStorage.removeItem("timetable");
    return [];
  }
}

function timeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

function loadAdmin() {
  adminBar.style.display = "flex";
  timetable = loadTimetable();
  render();
}

/* ================= RENDER ================= */

function render() {
  timetable.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
  main.innerHTML = "";

  if (timetable.length === 0) {
    main.innerHTML =
      '<div class="card" style="text-align:center;">No events yet.</div>';
    return;
  }

  timetable.forEach((event, i) => {
    const div = document.createElement("div");
    div.className = "card event-row";
    div.innerHTML = `
      <input class="name" value="${event.name || ''}" placeholder="Event name">

      <label>Start</label>
      <input class="start" type="time" value="${event.start || ''}">

      <label>End</label>
      <input class="end" type="time" value="${event.end || ''}">

      <label>Phase</label>
      <select class="phase">
        ${[1,2,3,4].map(p =>
          `<option value="${p}" ${p===event.phase?'selected':''}>
            Phase ${p}
          </option>`
        ).join("")}
      </select>

      <label>Severity</label>
      <select class="severity">
        <option value="3" ${event.severity===3?'selected':''}>3 â€“ Critical</option>
        <option value="2" ${event.severity===2?'selected':''}>2 â€“ Important</option>
        <option value="1" ${event.severity===1?'selected':''}>1 â€“ Light</option>
      </select>

      <div style="margin-top:15px; display:flex; gap:10px;">
        <button onclick="saveEvent(${i})">ðŸ’¾ Save</button>
        <button onclick="removeEvent(${i})">ðŸ—‘ Delete</button>
      </div>
    `;
    main.appendChild(div);
  });
}

/* ================= SAVE EVENT ================= */

function saveEvent(index) {
  const rows = document.querySelectorAll(".event-row");
  const row = rows[index];

  const name = row.querySelector(".name").value.trim();
  const start = row.querySelector(".start").value;
  const end = row.querySelector(".end").value;
  const phase = Number(row.querySelector(".phase").value);
  const severity = Number(row.querySelector(".severity").value);

  if (!name || !start || !end) {
    alert("Fill all fields.");
    return;
  }

  if (timeToMinutes(start) >= timeToMinutes(end)) {
    alert("Start must be before End.");
    return;
  }

  timetable[index] = { name, start, end, phase, severity };
  localStorage.setItem("timetable", JSON.stringify(timetable));
  localStorage.setItem("timetableUpdated", Date.now());

  render();

  // Success highlight
  setTimeout(() => {
    const cards = document.querySelectorAll(".event-row");
    if (cards[index]) {
      cards[index].classList.add("card-success");
      setTimeout(() => {
        cards[index].classList.remove("card-success");
      }, 1500);
    }
  }, 50);
}

/* ================= ADD / DELETE ================= */

function addEvent() {
  timetable.unshift({
    name: "",
    start: "",
    end: "",
    phase: 1,
    severity: 3
  });
  render();
}

function removeEvent(index) {
  timetable.splice(index, 1);
  localStorage.setItem("timetable", JSON.stringify(timetable));
  localStorage.setItem("timetableUpdated", Date.now());
  render();
}

/* ================= COUNTDOWN ================= */

function saveAdminCountdown() {
  const input = document.getElementById("adminCountdownDate");
  if (!input.value) return;

  const target = new Date(input.value + "T00:00:00");
  localStorage.setItem("countdownTarget", target.toISOString());
  alert("Countdown updated.");
}

/* ================= OTHER ================= */

function goHome() {
  location.href = "index.html";
}

function masterReset() {
  if (!confirm("Delete ALL app data?")) return;
  localStorage.clear();
  location.reload();
}

askForPin();

</script>
</body>
</html>
