<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug - Check Storage</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a1a;
      color: #0f0;
      padding: 20px;
      font-size: 14px;
    }
    .section {
      background: #2a2a2a;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #0f0;
    }
    h2 {
      color: #0ff;
      margin-top: 0;
    }
    pre {
      background: #000;
      padding: 10px;
      overflow-x: auto;
      border: 1px solid #0f0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-weight: bold;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
  </style>
</head>
<body>

<h1>üîç STORAGE DEBUG TOOL</h1>

<div class="section">
  <h2>Current Time</h2>
  <pre id="timeInfo"></pre>
</div>

<div class="section">
  <h2>Timetable in localStorage</h2>
  <pre id="timetableInfo"></pre>
</div>

<div class="section">
  <h2>Today's Log</h2>
  <pre id="logInfo"></pre>
</div>

<div class="section">
  <h2>Active Events (Should Show Now)</h2>
  <pre id="activeEvents"></pre>
</div>

<div class="section">
  <h2>Water Reminder Status</h2>
  <pre id="waterStatus"></pre>
</div>

<div class="section">
  <h2>All localStorage Keys</h2>
  <pre id="allKeys"></pre>
</div>

<div class="section">
  <h2>Actions</h2>
  <button onclick="refreshData()">üîÑ Refresh</button>
  <button onclick="goHome()">üè† Go Home</button>
  <button onclick="goAdmin()">‚öôÔ∏è Go Admin</button>
  <button onclick="createTestEvent()">‚ûï Create Test Event (Current Time)</button>
</div>

<script>
function toMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

function nowMinutes() {
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}

function todayKey() {
  return new Date().toISOString().split("T")[0];
}

function getCurrentTime() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const mins = now.getMinutes().toString().padStart(2, '0');
  return `${hours}:${mins}`;
}

function getTimetable() {
  try {
    const raw = localStorage.getItem("timetable");
    if (!raw) return [];
    return JSON.parse(raw);
  } catch (err) {
    return [];
  }
}

function getCurrentMainEvent() {
  const now = nowMinutes();
  const timetable = getTimetable();
  return timetable.filter(e => {
    const start = toMinutes(e.start);
    const end = toMinutes(e.end);
    return now >= start && now < end;
  });
}

function refreshData() {
  const now = new Date();
  const currentTime = getCurrentTime();
  const currentMinutes = nowMinutes();
  
  // Time info
  document.getElementById('timeInfo').innerHTML = `
Current Time: ${now.toLocaleString()}
Current Time (HH:MM): ${currentTime}
Current Minutes: ${currentMinutes}
Today Key: ${todayKey()}
  `;

  // Timetable
  const timetable = getTimetable();
  const timetableEl = document.getElementById('timetableInfo');
  
  if (timetable.length === 0) {
    timetableEl.innerHTML = '<span class="error">‚ùå NO TIMETABLE FOUND!</span>\n\nThis is why events don\'t show!\n\nGo to Admin and create events.';
  } else {
    timetableEl.innerHTML = `<span class="success">‚úÖ Timetable exists: ${timetable.length} events</span>\n\n` + 
      JSON.stringify(timetable, null, 2);
  }

  // Today's log
  const log = JSON.parse(localStorage.getItem(todayKey()) || '[]');
  const logEl = document.getElementById('logInfo');
  
  if (log.length === 0) {
    logEl.innerHTML = '<span class="warning">‚ö†Ô∏è No log entries for today yet</span>';
  } else {
    logEl.innerHTML = `<span class="success">‚úÖ ${log.length} log entries</span>\n\n` +
      JSON.stringify(log, null, 2);
  }

  // Active events
  const activeEvents = getCurrentMainEvent();
  const activeEl = document.getElementById('activeEvents');
  
  if (activeEvents.length === 0) {
    activeEl.innerHTML = `<span class="error">‚ùå NO ACTIVE EVENTS RIGHT NOW!</span>

Current time: ${currentTime} (${currentMinutes} minutes)

${timetable.length === 0 ? 'Reason: No timetable exists' : 
  'Reason: Current time is not within any event\'s time range\n\nEvents in timetable:\n' + 
  timetable.map(e => `  ‚Ä¢ ${e.name}: ${e.start} - ${e.end} (${toMinutes(e.start)} - ${toMinutes(e.end)} minutes)`).join('\n')}`;
  } else {
    activeEl.innerHTML = `<span class="success">‚úÖ ${activeEvents.length} ACTIVE EVENT(S)</span>\n\n` +
      JSON.stringify(activeEvents, null, 2);
  }

  // Water status
  const waterEl = document.getElementById('waterStatus');
  const dayStart = getDayStartMinute();
  const dayEnd = getDayEndMinute();
  
  if (dayStart === null) {
    waterEl.innerHTML = '<span class="error">‚ùå No day start (no timetable)</span>';
  } else {
    const waterInfo = shouldShowWaterReminder();
    if (waterInfo) {
      waterEl.innerHTML = `<span class="success">‚úÖ Water card should show</span>\n\nSlot: ${waterInfo.slot}\nStart minute: ${waterInfo.startMinute}`;
    } else {
      waterEl.innerHTML = '<span class="warning">‚ö†Ô∏è No water reminder now (already done or not time yet)</span>';
    }
  }

  // All localStorage keys
  const keys = Object.keys(localStorage);
  document.getElementById('allKeys').innerHTML = 
    `Total keys: ${keys.length}\n\n` +
    keys.map(k => {
      const val = localStorage.getItem(k);
      return `${k}: ${val.length > 100 ? val.substring(0, 100) + '...' : val}`;
    }).join('\n\n');
}

function getDayStartMinute() {
  const tt = getTimetable();
  if (tt.length === 0) return null;
  const starts = tt.map(e => toMinutes(e.start)).filter(n => !isNaN(n));
  if (starts.length === 0) return null;
  return Math.min(...starts);
}

function getDayEndMinute() {
  const tt = getTimetable();
  if (tt.length === 0) return null;
  const ends = tt.map(e => toMinutes(e.end)).filter(n => !isNaN(n));
  if (ends.length === 0) return null;
  return Math.max(...ends);
}

function shouldShowWaterReminder() {
  const dayStart = getDayStartMinute();
  if (dayStart === null) return null;

  const now = nowMinutes();
  if (now < dayStart) return null;

  const dayEnd = getDayEndMinute();
  if (dayEnd !== null && now >= dayEnd) return null;

  const elapsed = now - dayStart;
  const slot = Math.floor(elapsed / 60);

  const log = JSON.parse(localStorage.getItem(todayKey()) || '[]');
  
  const currentLogged = log.some(
    e => e.name === "Drink Water" && e.slot === slot
  );

  if (currentLogged) return null;

  const startMin = dayStart + slot * 60;
  return { slot, startMinute: startMin };
}

function goHome() {
  location.href = 'index.html';
}

function goAdmin() {
  location.href = 'admin.html';
}

function createTestEvent() {
  const now = new Date();
  const currentHour = now.getHours().toString().padStart(2, '0');
  const currentMin = now.getMinutes().toString().padStart(2, '0');
  const nextHour = ((now.getHours() + 1) % 24).toString().padStart(2, '0');
  
  const start = `${currentHour}:${currentMin}`;
  const end = `${nextHour}:${currentMin}`;
  
  const timetable = getTimetable();
  
  const testEvent = {
    name: "Test Event (Debug)",
    start: start,
    end: end,
    phase: 1,
    severity: 3
  };
  
  timetable.push(testEvent);
  localStorage.setItem('timetable', JSON.stringify(timetable));
  
  alert(`‚úÖ Test event created!\n\nName: Test Event (Debug)\nStart: ${start}\nEnd: ${end}\n\nGo to home page to see it!`);
  
  refreshData();
}

// Initial load
refreshData();
setInterval(refreshData, 5000); // Auto-refresh every 5 seconds
</script>

</body>
</html>
